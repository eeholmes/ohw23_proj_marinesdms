---
title: "actual SDM attempt"
output: html_document
date: "2023-08-10"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(maxnet)
library(dplyr)
library(maxnet)
library(sf)
library(stars)
library(geodata)
library(dismo)
library(lubridate)
library(sdmpredictors)
library(zoon)
```

## Load data in

```{r}
pts.abs <- read.csv("/home/jovyan/R/ohw23_proj_marinesdms/data/raw-bio/pts_absence.csv") # X is lon and Y is lat

io.turtles <- read.csv("/home/jovyan/R/ohw23_proj_marinesdms/data/raw-bio/io-sea-turtles.csv") 
```

## Format occurence data

```{r}
spp <- c("Chelonia mydas", "Caretta caretta", "Eretmochelys imbricata", "Lepidochelys olivacea", "Natator depressus", "Dermochelys coriacea") # turtle species we're interested in

occ <- io.turtles %>% 
  subset(scientificName == spp) # subsetting all the occurence data to just those turtles 

table(occ$scientificName) # seeing how often each species occurs

occ <- occ %>% # but we also need to subset the occurences to include just those in the water (not the ones on land)
  subset(bathymetry > 0 & 
                        shoredistance > 0 & 
                        coordinateUncertaintyInMeters < 200)

table(occ$scientificName) # seeing how often each species occurs now
# Caretta caretta is Loggerhead and Chelonia mydas is Green sea turtles 
```

## SDM predictors

### Loading in

```{r}
datasets <- list_datasets(terrestrial = FALSE, marine = TRUE)
View(datasets)

layers <- list_layers(datasets)
View(layers)
```

### Choosing and formatting

```{r}
#layercodes <- c("BO_sstmean", "BO_bathymin", "BO_bathymax", "BO_bathymean", "BO2_chlomax_bdmean", "BO2_dissoxmin_bdmean", "BO2_dissoxmean_bdmean", "BO2_dissoxrange_bdmean", "BO2_nitratemean_bdmean", "BO2_phosphatemean_bdmean", "BO2_tempmean_bdmean", "BO2_temprange_bdmean", "BO2_salinitymean_bdmean", "BO2_salinityrange_bdmean", "BO2_tempmean_ss", "BO2_temprange_ss", "BO2_chlomean_ss") # my first go around with lots of env variables (hint this takes FORever)

layercodes = c("BO_sstmean", "BO_bathymean", "BO22_ph", "BO2_dissoxmean_bdmean", "BO2_salinitymean_ss") # the env variables I chose from SDMpredictors

env <- load_layers(layercodes) # take out the equalarea arg or you will be sad

lats <- c(-0.125, 32.125); lons <- c(41.875, 70.125) # IO lat/lon range
# raster extent is defined by west lon, east lon, south lat, north lat
ext <- raster::extent(lons[1], lons[2], lats[1], lats[2])
extent_polygon <- as(ext, "SpatialPolygons") %>% st_as_sf()
# we need to assign a coordinate system; 4326 is the default for maps in sf
sf::st_crs(extent_polygon)<-4326 # applying a coordinate system

plot(extent_polygon) # look a rectangle

io.rast <- raster::crop(env, extent(extent_polygon))
plot(io.rast) # look NOT a rectangle- your env variables cropped to the Indian Ocean!
```

