---
title: "get background data"
output: html_document
date: "2023-08-08"
---

Here we explore 2 approaches.

* Get all occurrences from robis in our polygon of interest and use that for lat/lon
* Get random locations from our polygon of interest

## Set up

```{r}
library(ggplot2)
library(sf)
library("rnaturalearth")
library("rnaturalearthdata")
library(raster)
library(tidyverse)
```

```{r}
dir_data <- file.path(here::here(), "data", "raw-bio")
dir_env <- file.path(here::here(), "data", "env")
redo <- TRUE
```

## Define the region of interest

```{r}
# lon, lon, lat, lat
library(sf)
lats <- c(-0.125, 32.125)
lons <- c(41.875, 65.125)
# raster extent is defined by west lon, east lon, south lat, north lat
ext <- raster::extent(lons[1], lons[2], lats[1], lats[2])
extent_polygon <- as(ext, "SpatialPolygons") %>% st_as_sf()
# we need to assign a coordinate system; 4326 is the default for maps in sf
sf::st_crs(extent_polygon)<-4326
# convert to a WKT format
wkt_geometry <- extent_polygon$geometry %>% st_as_text()
wkt_geometry
```

Make a map of our region so we know we have the right area.
```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")
ggplot(data = world) + geom_sf() +
  geom_sf(data = extent_polygon, color = "red", fill=NA)
```

## Get occurrence data from robis

```{r}
cols.to.use <- c("scientificName", "dateIdentified", "eventDate", "decimalLatitude", "decimalLongitude", "coordinateUncertaintyInMeters", "bathymetry",  "shoredistance", "sst", "sss")
```

```{r}
library(robis)
# Alas no bathymetry is downloaded
df <- occurrence(geometry = wkt_geometry, wrims=TRUE, dna = FALSE, fields = cols.to.use)
```


Save the data to a file for later use.
```{r eval = FALSE}
fil <- file.path(here::here(), "data", "raw-bio", "io-background.csv")
write.csv(df, file=fil, quote=FALSE)
```


### Read in the background

```{r}
fil <- file.path(here::here(), "data", "raw-bio", "io-background.csv")
back1 <- read.csv(fil)
```


### Make a plot of the background

This approach is not terribly random.

```{r}
library(ggplot2)
library("ggspatial")
library("sf")
theme_set(theme_bw())
world <- st_make_valid(world)
world_points <- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))


plt <- ggplot(data = world) +
    geom_sf(fill= "antiquewhite") +
    geom_point(data = back1, aes(x=decimalLongitude, y=decimalLatitude), color = "red", size=0.1) +
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.15, "in"), pad_y = unit(0.25, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = lons, ylim = lats) +
    theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"))

sf_use_s2(FALSE)
plt + geom_text(data = world_points, aes(x=X, y=Y, label=name),
          color = "darkblue", size=2, check_overlap = TRUE) +
  xlab("longitude") + ylab("latitude")

```

## Approach 2. Random samples

This is adapted from [here](https://bbest.github.io/eds232-ml/lab1a_sdm-explore.html).

### Get a marine raster layer

We just need one because we use this to sample lat/lons from the marine environment.

```{r}
# set a default data directory
options(sdmpredictors_datadir = dir_env)

# choosing marine
env_datasets <- sdmpredictors::list_datasets(terrestrial = FALSE, marine = TRUE)
env_layers <- sdmpredictors::list_layers("MARSPEC")
env_stack <- sdmpredictors::load_layers("MS_bathy_5m")
env_stack <- env_stack %>% raster::crop(ext)
```

Now we can plot the bathymetry in our study region.

```{r}
plot(env_stack)
```
  
### Next we sample points from this


```{r}
nsamp <- 1000
absence <- dismo::randomPoints(env_stack[[1]], nsamp) %>% 
    as_tibble() %>% 
    st_as_sf(coords = c("x", "y"), crs = 4326)
```

```{r}
mapview::mapview(absence, col.regions = "gray")
```

Save the absence locations to a file.

```{r save-absence}
absence_geo <- file.path(dir_data, "absence.geojson")
pts_absence_csv <- file.path(dir_data, "pts_absence.csv")
st_write(absence, pts_absence_csv, layer_options = "GEOMETRY=AS_XY", append=FALSE)
```

