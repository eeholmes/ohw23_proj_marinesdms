---
title: "Getting background data from OBIS"
output: html_document
date: "2023-08-08"
---

Here we explore 2 approaches.

* Get all occurrences from robis in our polygon of interest and use that for lat/lon
* Get random locations from our polygon of interest

# Loading libraries

```{r libraries, message = F}
#Deal with spatial data
library(sf)
#Base maps and plotting spatial data
library(rnaturalearth)
# library(ggspatial)
library(mapview)
# library(rnaturalearthdata)
# library(raster)
#Data visualisation and manipulation
library(tidyverse)
#Find files easily
library(here)
#Access to OBIS
library(robis)
```
  
# Setting base directories
These directories contain the biological data (i.e., presence locations of loggerhead sea turtles) and environmental data.  
  
```{r base_dir}
#Setting directories containing input data
dir_data <- file.path(here(), "data/raw-bio")
dir_env <- file.path(here(), "data/env")
```

# Loading bounding box for region of interest
In the `01_Presence_Data` notebook, we created a bounding box for our region of interest. We will load this bounding box here to spatially constrain our data.

```{r}
#Loading bounding box for the area of interest
extent_polygon <- read_sf("../data/BoundingBox.shp")

#Extract polygon geometry 
pol_geometry <- st_as_text(extent_polygon$geometry)
```
  
## Plotting region of interest 
This allows us to check our polygon of interest is located in the correct region.  
  
```{r map_aoi}
#Getting base map
world <- ne_countries(scale = "medium", returnclass = "sf")

#Plotting map
ggplot() + 
  #Adding base map
  geom_sf(data = world) +
  #Adding bounding box
  geom_sf(data = extent_polygon, color = "red", fill = NA)+
  #Setting theme of plots to not include a grey background
  theme_bw()
```
  
Our bounding box is definitely in the region we are interested in. We will use this bounding box to filter out presence data from OBIS.  
    
# Approach 1. Other marine species presence as background samples
## Getting occurrence data from OBIS
We will use `robis` to get observations for marine species from OBIS within our bounding box. OBIS data includes about 100 different columns, but not all of these columns are relevant to us. We will define the columns that we need and then we will perform a search of the OBIS database.  
  
### Defining relevant columns
```{r rel_cols}
cols.to.use <- c("scientificName", "dateIdentified", "eventDate", "decimalLatitude", "decimalLongitude", "coordinateUncertaintyInMeters", "bathymetry",  "shoredistance", "sst", "sss")
```
  
### Querying OBIS
By setting the `wrims` parameter to `TRUE` we include observations of species registerd in the [World Register of Introduced Marine Species (WRiMS)](https://www.marinespecies.org/introduced/index.php).  
  
```{r obis_query}
#Applying bounding box and including WRiMS species
background <- occurrence(geometry = pol_geometry, wrims = TRUE, 
                         #DNA data is not needed, subsetting columns of interest
                         dna = FALSE, fields = cols.to.use,
                         #Excluding records labelled as being on land
                         exclude = "ON_LAND")
```
## Saving background data
```{r save_bg}
#Setting full file path to save background information
file_path_out <- file.path(dir_data, "io-background.csv")

#Saving background data as csv
write_csv(background, file_path_out)
```
  
## (Optional) Load background data
If you have previously downloaded the background data, you can simply load the data to the environment instead of downloading it again. To do this, you can use the code below.  
  
```{r load_bg}
#Find background file in our biological data folder
file_path_bg <- list.files(dir_data, pattern = "background", full.names = T)

#Load file
background_1 <- read_csv(file_path_bg)
```
  
## Plotting background data
We will create a map with all the observations we obtained from OBIS within our region of interest.  
  
```{r plot_bg1}
#Extracting labels for countries in base map
world_points <- world %>% 
  #Getting centroids for all polygons in the world base map
  st_centroid(geometry) %>% 
  #Getting coordinates for each centroid
  st_coordinates() %>% 
  #Adding centroids to original base map
  bind_cols(world)

#Saving map into variable
plt <- ggplot()+
  #Add world base map and change land colour
  geom_sf(data = world, fill = "antiquewhite")+
  #Add background points
  geom_point(data = background_1, 
             #Point to coordinates for background points
             aes(x = decimalLongitude, y = decimalLatitude), 
             #Changing color and size of points for background data
             color = "red", size = 0.1)+
  #Decrease map limits to focus on area of interest
  lims(x = c(st_bbox(extent_polygon)$xmin, st_bbox(extent_polygon)$xmax),
       y = c(st_bbox(extent_polygon)$ymin, st_bbox(extent_polygon)$ymax))+
  #Add scale bar on the top right of the plot
  annotation_scale(location = "tr", width_hint = 0.5)+
  #Add north arrow on the top left of plot
  annotation_north_arrow(location = "tl", which_north = "true",
                         #Include small buffer from plot edge
                         pad_x = unit(0.01, "in"), pad_y = unit(0.05, "in"),
                         #Set style of north arrow
                         style = north_arrow_fancy_orienteering) +
  #Changing color, type and size of grid lines
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), 
        #Change background of map
        panel.background = element_rect(fill = "aliceblue"))

#Do not use spherical geometry
sf_use_s2(FALSE)

#Adding labels to map
plt <- plt+
  geom_text(data = world_points, 
            #Point to coordinates and column with country names
            aes(x = X, y = Y, label = name),
            #Changing color and size of labels
            color = "darkblue", size = 3, 
            #Avoid label overlap
            check_overlap = TRUE) +
  #Change axes labels
  labs(x = "longitude", y = "latitude")

#Checking final map
plt
```
  
As you can see from the map above, this approach is not truly random. This is why we are including a second method to create background samples.

## Approach 2. Random samples

This is adapted from [here](https://bbest.github.io/eds232-ml/lab1a_sdm-explore.html).

### Get a marine raster layer

We just need one because we use this to sample lat/lons from the marine environment.

```{r}
# set a default data directory
options(sdmpredictors_datadir = dir_env)

# choosing marine
env_datasets <- sdmpredictors::list_datasets(terrestrial = FALSE, marine = TRUE)
env_layers <- sdmpredictors::list_layers("MARSPEC")
env_stack <- sdmpredictors::load_layers("MS_bathy_5m")
env_stack <- env_stack %>% raster::crop(ext)
```

Now we can plot the bathymetry in our study region.

```{r}
plot(env_stack)
```
  
### Next we sample points from this


```{r}
nsamp <- 1000
absence <- dismo::randomPoints(env_stack[[1]], nsamp) %>% 
    as_tibble() %>% 
    st_as_sf(coords = c("x", "y"), crs = 4326)
```

```{r}
mapview(absence, col.regions = "gray")
```

Save the absence locations to a file.

```{r save-absence}
absence_geo <- file.path(dir_data, "absence.geojson")
pts_absence_csv <- file.path(dir_data, "pts_absence.csv")
st_write(absence, pts_absence_csv, layer_options = "GEOMETRY=AS_XY", append=FALSE)
```

