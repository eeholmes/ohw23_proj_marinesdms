---
title: "Getting sea turtle observations"
output:
  md_document:
    variant: markdown_github
date: "2023-08-08"
---

# Goal of the notebook
In this notebook, we will show how you can get some [Loggerhead sea turtle (*Caretta caretta*)](https://www.iucnredlist.org/species/3897/119333622) data between 2000 and 2023 from the [Ocean Biodiversity Information System (OBIS)](https://obis.org/). We will use the `robis` package to search the OBIS library and download relevant data.  
  
# Loading relevant libraries
```{r libraries, warning = F}
#Dealing with spatial data
library(sf)
#Getting base maps
library(rnaturalearth)
library(rnaturalearthdata)
#Access to OBIS
library(robis)
#Data manipulation and visualisation
library(tidyverse)
library(janitor)
```

# Creating a bounding box
We will use a bounding box for the region of our interest (Arabian Sea and the Bay of Bengal) to extract *C. caretta* data relevant to our study area.  
  
```{r bounding_box}
#We create a bounding box using minimum and maximum coordinate pairs
extent_polygon <- st_bbox(c(xmin = 41.875, xmax = 65.125, 
                            ymax = -0.125, ymin = 32.125), 
                          #Assign reference system
                          crs = st_crs(4326)) %>% 
  #Turn into sf object
  st_as_sfc()

#Extract polygon geometry 
pol_geometry <- st_as_text(extent_polygon[[1]])
```
  
# Searching for sea turtle occurrence from OBIS
We will use the `robis` package to find observations of Loggerhead sea turtles (*C. caretta*) published in OBIS.  

```{r obis_search}
#Search OBIS for loggerhead observations from 2000
caretta_obs <- occurrence("Caretta caretta", 
                          startdate = as.Date("2000-01-01"),
                          #Apply spatial constraint
                          geometry = pol_geometry)

#Check structure of results
glimpse(caretta_obs)
```
  
## Exploring OBIS results
Our search produced `r nrow(caretta_obs)` results for the area of our interest. However, before we continue to use this data as input for our species distribution models, we must clean it first to ensure we have a good quality dataset.  
  
In this section, we will explore the results of our OBIS search so we can design a data cleaning workflow. We will check the content of some of the columns in our data frame.  

You may want to refer to the [OBIS manual](https://manual.obis.org/darwin_core.html) and the OBIS webpage about [Data Access](https://obis.org/data/access/).
  
```{r}
#Checking values in 
caretta_obs %>% 
  #Removing observations for which there is no date
  drop_na(eventDate)
  
  #Removing any empty columns
  # remove_empty("cols")
  
```



## Keeping relevant columns
```{r, eval=F}
cols.to.use <- c("occurrenceID", "scientificName", "dateIdentified", "eventDate", "decimalLatitude", "decimalLongitude", "coordinateUncertaintyInMeters",
                 "individualCount","lifeStage", "sex",
                 "bathymetry",  "shoredistance", "sst", "sss")
df <- df[,cols.to.use]
write.csv(df, file="/home/jovyan/R/ohw23_proj_marinesdms/data/raw-bio/loggerhead-robis.csv", quote=FALSE)
```


```{r,eval=F}


world <- ne_countries(scale = "medium", returnclass = "sf")
ggplot(data = world) + geom_sf() +
  geom_sf(data = extent_polygon, color = "red", fill=NA)

```

Columns to get. Others? Gender?

```{r,eval=F}
# select columns
    colsWeNeed <- c("species", "lat", "lon", "locality", "year", 
        "coordinateUncertaintyInMeters", "occurrenceID", "occurrenceRemarks", 
        "geodeticDatum")
```

Get a data frame of loggerhead sea turtle data

```{r,eval=F}
spp <- "Caretta caretta"
loggerh <- dismo::gbif("Caretta", species = "caretta", 
        nrecs = 300, geo = TRUE, removeZeros = TRUE, ext = ext)

```

## Get data from robis

```{r,eval=F}

df <- occurrence("Abra alba", geometry = "POLYGON ((2.59689 51.16772, 2.62436 51.14059, 2.76066 51.19225, 2.73216 51.20946, 2.59689 51.16772))")
df <- occurrence("Caretta caretta", startdate = as.Date("2000-01-01"))
```

## To do

* Get more sea turtle data
* plot the data
* find the turtles that are at sea and not on land
* add a column for "on land" so we can analyze those separately